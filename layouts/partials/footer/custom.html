<!-- 背景 -->
<div id="particles-js"></div>

<script src={{ (resources.Get "background/particles.min.js" ).Permalink }}></script>
<script>
  particlesJS.load('particles-js', {{ (resources.Get "background/particlesjs-config.json").Permalink }}, function () {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>

<!-- 字体 -->
<style>
  @font-face {
    font-family: 'JetBrainsMono-Regular-2';
    src: url('{{ (resources.Get "font/JetBrains-Mono/JetBrainsMono-Regular-2.ttf").Permalink }}') format('truetype');
  }

  @font-face {
    font-family: 'SourceHanSansCN-VF-2';
    src: url('{{ (resources.Get "font/SiYuanHeiTi-CN-VF/SourceHanSansCN-VF-2.otf").Permalink }}') format('opentype');
  }

  :root {
    --base-font-family: 'SourceHanSansCN-VF-2';
    --code-font-family: 'JetBrainsMono-Regular-2';
    /* 修正了变量名不一致的问题 */
  }
</style>

<!-- 折叠代码 -->
<style>
  #backTopBtn {
    display: none;
    position: fixed;
    bottom: 30px;
    z-index: 99;
    cursor: pointer;
    width: 30px;
    height: 30px;
    background-image: url('{{ (resources.Get "icons/backTop.svg").Permalink }}');
    background-size: contain;
    background-repeat: no-repeat;
  }
</style>

<script>
  function initScrollTop() {
    let rightSideBar = document.querySelector(".right-sidebar");
    if (!rightSideBar) return;

    let btn = document.createElement("div");
    btn.id = "backTopBtn";
    btn.onclick = function () {
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    rightSideBar.appendChild(btn);

    window.addEventListener('scroll', function () {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        btn.style.display = "block";
      } else {
        btn.style.display = "none";
      }
    });
  }
  // 立即初始化
  document.addEventListener("DOMContentLoaded", initScrollTop);
</script>

<style>
  .highlight {
    max-height: 400px;
    overflow: hidden;
    position: relative;
    transition: max-height 0.3s ease;
  }

  .code-show {
    max-height: none !important;
    padding-bottom: 40px;
  }

  .code-more-box {
    width: 100%;
    padding-top: 60px;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0), var(--card-background, #fff));
    position: absolute;
    left: 0;
    bottom: 0;
    z-index: 1;
  }

  .code-more-box.expanded {
    background: none;
    position: relative;
    padding-top: 10px;
  }

  .code-more-btn {
    display: block;
    margin: auto;
    width: 44px;
    height: 30px;
    cursor: pointer;
    text-align: center;
  }

  .code-more-img {
    display: inline-block;
    width: 22px;
    height: 16px;
    transition: transform 0.3s;
  }

  .code-show .code-more-img {
    transform: rotate(180deg);
  }

  /* 黑暗模式下折叠展开图标变为白色 */
  [data-scheme="dark"] .code-more-img {
    filter: brightness(0) invert(1);
  }
</style>

<script>
  function initCodeMoreBox() {
    let codeBlocks = document.querySelectorAll(".highlight");

    codeBlocks.forEach(codeBlock => {
      if (codeBlock.scrollHeight <= 400) return;

      let codeMoreBox = document.createElement('div');
      codeMoreBox.classList.add('code-more-box');

      let codeMoreBtn = document.createElement('span');
      codeMoreBtn.classList.add('code-more-btn');

      let img = document.createElement('img');
      img.classList.add('code-more-img');
      // 修正 Hugo 变量注入方式，添加引号
      img.src = '{{ (resources.Get "icons/fold-down.svg").Permalink }}';

      codeMoreBtn.onclick = function () {
        const isExpanded = codeBlock.classList.contains('code-show');
        if (isExpanded) {
          codeBlock.classList.remove('code-show');
          codeMoreBox.classList.remove('expanded');
          codeBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          codeBlock.classList.add('code-show');
          codeMoreBox.classList.add('expanded');
        }
        window.dispatchEvent(new Event('resize'));
      };

      codeMoreBtn.appendChild(img);
      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox);
    });
  }

  // 使用更可靠的加载方式
  window.onload = function () {
    setTimeout(initCodeMoreBox, 300);
  };
</script>

<!-- 看板娘 -->
<!-- 【custom.html】 -->
<script>
  // 获取博客本地资源地址
  const cssPath = {{ (resources.Get "waifu/waifu.css").Permalink }}
  const tipsJsonPath = {{ (resources.Get "waifu/waifu-tips.json").Permalink }}
  // live2d_path 参数建议使用绝对路径
  const live2d_path = "https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/";

  // 封装异步加载资源的方法
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      }
      else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => resolve(url);
        tag.onerror = () => reject(url);
        document.head.appendChild(tag);
      }
    });
  }

  // 加载 waifu.css live2d.min.js waifu-tips.js
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(cssPath, "css"),
      loadExternalResource(live2d_path + "live2d.min.js", "js"),
      loadExternalResource(live2d_path + "waifu-tips.js", "js")
    ]).then(() => {
      // 配置选项的具体用法见 README.md
      initWidget({
        waifuPath: tipsJsonPath,
        cdnPath: "https://fastly.jsdelivr.net/gh/fghrsh/live2d_api/",
        tools: ["hitokoto", "asteroids", "switch-model", "switch-texture", "photo", "info", "quit"]
      });
    });
  }
</script>

<script>
  // 看板娘拖动功能 - 修复版本
  document.addEventListener('DOMContentLoaded', function () {
    // 等待 waifu 元素加载完成
    const observer = new MutationObserver(function () {
      const waifuElement = document.getElementById('waifu');
      if (waifuElement && !waifuElement.hasAttribute('draggable-enabled')) {
        waifuElement.setAttribute('draggable-enabled', 'true');
        enableDragging(waifuElement);
        observer.disconnect();
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // 6秒后如果还没找到元素，则尝试直接添加
    setTimeout(function () {
      const waifuElement = document.getElementById('waifu');
      if (waifuElement && !waifuElement.hasAttribute('draggable-enabled')) {
        enableDragging(waifuElement);
      }
    }, 6000);
  });

  function enableDragging(waifuElement) {
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;

    // 记录初始位置
    const computedStyle = window.getComputedStyle(waifuElement);
    let initialRight = parseFloat(computedStyle.right) || 10;
    let initialBottom = parseFloat(computedStyle.bottom) || 0;

    // 直接在 waifu 元素上绑定事件，阻止事件冒泡
    waifuElement.addEventListener('mousedown', function (e) {
      // 如果点击的是工具按钮，不进行拖动
      if (e.target.closest('#waifu-tool')) {
        return;
      }

      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;

      // 计算当前元素的位置
      const rect = waifuElement.getBoundingClientRect();
      currentX = rect.left;
      currentY = rect.top;

      // 阻止事件冒泡，防止与其他事件冲突
      e.stopPropagation();
    });

    document.addEventListener('mousemove', function (e) {
      if (isDragging) {
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;

        // 设置新位置
        const newX = currentX + deltaX;
        const newY = currentY + deltaY;

        // 确保不超出视口边界
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const waifuWidth = waifuElement.offsetWidth;
        const waifuHeight = waifuElement.offsetHeight;

        const clampedX = Math.max(0, Math.min(viewportWidth - waifuWidth, newX));
        const clampedY = Math.max(0, Math.min(viewportHeight - waifuHeight, newY));

        // 设置元素位置
        waifuElement.style.left = clampedX + 'px';
        waifuElement.style.top = clampedY + 'px';
        waifuElement.style.right = 'auto';
        waifuElement.style.bottom = 'auto';

        // 阻止事件冒泡
        e.stopPropagation();
      }
    });

    document.addEventListener('mouseup', function (e) {
      if (isDragging) {
        isDragging = false;
        e.stopPropagation();
      }
    });

    // 移动端支持
    waifuElement.addEventListener('touchstart', function (e) {
      if (e.target.closest('#waifu-tool')) {
        return;
      }

      isDragging = true;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;

      const rect = waifuElement.getBoundingClientRect();
      currentX = rect.left;
      currentY = rect.top;

      e.stopPropagation();
    });

    document.addEventListener('touchmove', function (e) {
      if (isDragging) {
        const deltaX = e.touches[0].clientX - startX;
        const deltaY = e.touches[0].clientY - startY;

        const newX = currentX + deltaX;
        const newY = currentY + deltaY;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const waifuWidth = waifuElement.offsetWidth;
        const waifuHeight = waifuElement.offsetHeight;

        const clampedX = Math.max(0, Math.min(viewportWidth - waifuWidth, newX));
        const clampedY = Math.max(0, Math.min(viewportHeight - waiguHeight, newY));

        waifuElement.style.left = clampedX + 'px';
        waifuElement.style.top = clampedY + 'px';
        waifuElement.style.right = 'auto';
        waifuElement.style.bottom = 'auto';

        e.stopPropagation();
      }
    });

    document.addEventListener('touchend', function (e) {
      if (isDragging) {
        isDragging = false;
        e.stopPropagation();
      }
    });
  }
</script>